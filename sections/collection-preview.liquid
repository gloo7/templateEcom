{% liquid
  assign collection = collections[section.settings.collection]
  assign now_ts = 'now' | date: '%s' | plus: 0
  assign new_days = section.settings.new_days | default: 14
%}

<section class="jp-cpv" data-section-id="{{ section.id }}">
  <div class="jp-cpv__inner page-width">
    <div class="jp-cpv__header">
      {% if section.settings.heading != blank %}
        <h2 class="jp-cpv__title">{{ section.settings.heading }}</h2>
      {% endif %}

      {% if section.settings.show_view_all and collection != blank %}
        <a class="jp-cpv__viewall" href="{{ collection.url }}">
          {{ section.settings.view_all_text }}
          <span class="jp-cpv__viewall-circle" aria-hidden="true"></span>
        </a>
      {% endif %}
    </div>

    {% if collection == blank %}
      <p>请选择一个商品系列（Collection）。</p>
    {% else %}
      <div class="jp-cpv__grid" style="--cols: {{ section.settings.columns_desktop }};">
        {% for product in collection.products limit: section.settings.products_to_show %}
          {% liquid
            assign is_new = false
            if product.published_at
              assign pub_ts = product.published_at | date: '%s' | plus: 0
              assign diff_days = now_ts | minus: pub_ts | divided_by: 86400
              if diff_days <= new_days
                assign is_new = true
              endif
            endif

            assign img1 = product.featured_image
            assign img2 = product.images[1]

            assign color_option_name = ''
            for opt in product.options_with_values
              assign n = opt.name | strip
              if n == 'Color' or n == '颜色' or n == '顏色' or n == 'colour' or n == 'COLOUR' or n == 'COLOR'
                assign color_option_name = opt.name
              endif
            endfor

            assign color_values = ''
            if color_option_name != ''
              for v in product.options_with_values
                if v.name == color_option_name
                  for val in v.values
                    assign color_values = color_values | append: val | append: '||'
                  endfor
                endif
              endfor
            endif
          %}

          <article class="jp-card" data-handle="{{ product.handle }}">
            <div class="jp-card__media">
              <a href="{{ product.url }}" class="jp-card__link" aria-label="{{ product.title | escape }}">
                {% if img1 %}
                  <div class="jp-card__imgwrap">
                    {{ img1 | image_url: width: 720 | image_tag: class: 'jp-card__img jp-card__img--primary', loading: 'lazy' }}
                    {% if img2 and section.settings.enable_hover_image %}
                      {{ img2 | image_url: width: 720 | image_tag: class: 'jp-card__img jp-card__img--secondary', loading: 'lazy' }}
                    {% endif %}
                  </div>
                {% endif %}

                {% if is_new and section.settings.show_new_badge %}
                  <span class="jp-badge jp-badge--new">{{ section.settings.new_badge_text }}</span>
                {% endif %}
              </a>

              {% if section.settings.enable_wishlist %}
                <button class="jp-wish" type="button" aria-label="收藏" data-wish-btn>
                  <span class="jp-wish__icon" aria-hidden="true"></span>
                </button>
              {% endif %}
            </div>

            <div class="jp-card__meta">
              <div class="jp-card__row">
                <a class="jp-card__name" href="{{ product.url }}">{{ product.title }}</a>
              </div>

              {% if section.settings.show_price %}
                <div class="jp-card__price">
                  {{ product.price | money }}
                </div>
              {% endif %}

              {% if section.settings.show_swatches and color_values != '' %}
                <div class="jp-swatches" aria-label="颜色选项">
                  {% assign map_text = section.settings.color_map | strip %}
                  {% assign count = 0 %}
                  {% assign seen = '' %}

                  {% assign color_array = color_values | split: '||' %}
                  {% for raw in color_array %}
                    {% assign v = raw | strip %}
                    {% if v == '' %}{% continue %}{% endif %}

                    {% unless seen contains v %}
                      {% assign seen = seen | append: '|' | append: v | append: '|' %}
                      {% assign count = count | plus: 1 %}
                      {% if count > section.settings.swatch_limit %}{% break %}{% endif %}

                      {% assign color_css = v | downcase | strip %}

                      {%- comment -%} 颜色映射：每行 "颜色名: #hex" {%- endcomment -%}
                      {% if map_text != '' %}
                        {% assign mapped = '' %}
                        {% assign map_lines = map_text | split: '\n' %}
                        {% for line in map_lines %}
                          {% assign ln = line | strip %}
                          {% if ln == '' %}{% continue %}{% endif %}

                          {% assign pair = ln | split: ':' %}
                          {% if pair.size < 2 %}{% continue %}{% endif %}

                          {% assign key = pair[0] | strip %}
                          {% assign val = pair[1] | strip %}

                          {% if key == v %}
                            {% assign mapped = val %}
                            {% break %}
                          {% endif %}
                        {% endfor %}

                        {% if mapped != '' %}
                          {% assign color_css = mapped %}
                        {% endif %}
                      {% endif %}

                      <span class="jp-swatch" title="{{ v | escape }}" style="--sw: {{ color_css }};"></span>
                    {% endunless %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <style>
    .jp-cpv{padding:56px 0;}
    .jp-cpv__inner{max-width: var(--page-width, 1200px); margin:0 auto;}
    .jp-cpv__header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:22px;}
    .jp-cpv__title{font-size:34px; line-height:1.1; margin:0; letter-spacing:.2px;}
    .jp-cpv__viewall{display:inline-flex; align-items:center; gap:10px; text-decoration:none; font-size:14px; color:inherit; opacity:.9;}
    .jp-cpv__viewall:hover{opacity:1;}
    .jp-cpv__viewall-circle{width:34px; height:34px; border:1px solid rgba(0,0,0,.25); border-radius:999px; display:inline-block;}

    .jp-cpv__grid{display:grid; grid-template-columns: repeat(var(--cols), minmax(0,1fr)); gap:26px 22px;}
    @media (max-width: 990px){ .jp-cpv__grid{grid-template-columns: repeat(2, minmax(0,1fr));} .jp-cpv__title{font-size:28px;} }
    @media (max-width: 560px){ .jp-cpv__grid{grid-template-columns: repeat(3, minmax(0,1fr)); gap:18px 14px;} .jp-cpv__title{font-size:26px;} }

    .jp-card{position:relative;}
    .jp-card__media{position:relative;}
    .jp-card__link{text-decoration:none; color:inherit; display:block;}
    .jp-card__imgwrap{position:relative; overflow:hidden; background:#f3f3f3;}
    .jp-card__img{width:100%; height:auto; display:block; transform:translateZ(0); transition:opacity .25s ease, transform .35s ease;}
    .jp-card__img--secondary{position:absolute; inset:0; opacity:0;}
    .jp-card:hover .jp-card__img--secondary{opacity:1;}
    .jp-card:hover .jp-card__img--primary{opacity:0;}
    .jp-card:hover .jp-card__img{transform:scale(1.01);}

    .jp-badge{position:absolute; top:10px; left:10px; font-size:11px; padding:3px 8px; border-radius:2px; letter-spacing:.3px;}
    .jp-badge--new{background:#d9c27a; color:#fff;}

    .jp-wish{position:absolute; right:10px; bottom:10px; width:34px; height:34px; border:0; background:rgba(255,255,255,.92); border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center;}
    .jp-wish:hover{background:#fff;}
    .jp-wish__icon{width:18px; height:18px; display:block; background:currentColor; -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12.1 20.3l-.1.1-.1-.1C7.1 16.2 4 13.4 4 9.9 4 7.4 5.9 5.5 8.4 5.5c1.4 0 2.8.7 3.6 1.8.8-1.1 2.2-1.8 3.6-1.8 2.5 0 4.4 1.9 4.4 4.4 0 3.5-3.1 6.3-7.9 10.4z'/%3E%3C/svg%3E") center/contain no-repeat; mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12.1 20.3l-.1.1-.1-.1C7.1 16.2 4 13.4 4 9.9 4 7.4 5.9 5.5 8.4 5.5c1.4 0 2.8.7 3.6 1.8.8-1.1 2.2-1.8 3.6-1.8 2.5 0 4.4 1.9 4.4 4.4 0 3.5-3.1 6.3-7.9 10.4z'/%3E%3C/svg%3E") center/contain no-repeat;
    }
    .jp-wish.is-active{color:#111;}
    .jp-wish.is-active .jp-wish__icon{background:#111;}

    .jp-card__meta{padding-top:10px;}
    .jp-card__name{display:block; font-size:12px; line-height:1.25; text-decoration:none; color:inherit; opacity:.95; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .jp-card__price{font-size:13px; margin-top:6px; font-weight:600;}

    .jp-swatches{display:flex; gap:6px; margin-top:8px; align-items:center;}
    .jp-swatch{width:10px; height:10px; border-radius:999px; border:1px solid rgba(0,0,0,.15); background:var(--sw, #ddd);}
    @media (max-width: 560px){
      .jp-card__name{font-size:11px;}
      .jp-card__price{font-size:12px;}
    }
  </style>

  <script>
    (function(){
      var root = document.querySelector('.jp-cpv[data-section-id="{{ section.id }}"]');
      if(!root) return;

      var key = 'jp_wishlist_v1';
      function read(){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
      function write(arr){ try { localStorage.setItem(key, JSON.stringify(arr)); } catch(e){} }

      var list = read();
      root.querySelectorAll('[data-wish-btn]').forEach(function(btn){
        var card = btn.closest('.jp-card');
        var handle = card ? card.getAttribute('data-handle') : '';
        if(!handle) return;

        if(list.indexOf(handle) !== -1) btn.classList.add('is-active');

        btn.addEventListener('click', function(){
          var cur = read();
          var i = cur.indexOf(handle);
          if(i === -1){ cur.push(handle); btn.classList.add('is-active'); }
          else { cur.splice(i,1); btn.classList.remove('is-active'); }
          write(cur);
        });
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "JP Collection Preview",
  "settings": [
    { "type": "text", "id": "heading", "label": "标题", "default": "Women" },
    { "type": "collection", "id": "collection", "label": "选择商品系列" },

    { "type": "range", "id": "products_to_show", "label": "显示商品数量", "min": 3, "max": 18, "step": 1, "default": 9 },
    { "type": "range", "id": "columns_desktop", "label": "桌面端列数", "min": 2, "max": 5, "step": 1, "default": 3 },

    { "type": "checkbox", "id": "show_price", "label": "显示价格", "default": true },
    { "type": "checkbox", "id": "enable_hover_image", "label": "hover 显示第二张图（有第二张才生效）", "default": true },

    { "type": "checkbox", "id": "show_new_badge", "label": "显示 NEW 角标", "default": true },
    { "type": "range", "id": "new_days", "label": "多少天内算 NEW", "min": 1, "max": 60, "step": 1, "default": 14 },
    { "type": "text", "id": "new_badge_text", "label": "NEW 文案", "default": "NEW" },

    { "type": "checkbox", "id": "enable_wishlist", "label": "显示收藏心形（本地收藏）", "default": true },

    { "type": "checkbox", "id": "show_swatches", "label": "显示颜色圆点（Color/颜色/顏色）", "default": true },
    { "type": "range", "id": "swatch_limit", "label": "最多显示几个颜色圆点", "min": 1, "max": 6, "step": 1, "default": 4 },

    {
      "type": "textarea",
      "id": "color_map",
      "label": "颜色映射（可选，每行：颜色名:色值）",
      "default": "灰色:#B9B9B9\n藍色:#2F5D9E\n黑色:#111111\n白色:#F4F4F4\n粉色:#E8A7B6\n米色:#D8C7A5"
    },

    { "type": "checkbox", "id": "show_view_all", "label": "显示“查看全部”按钮", "default": true },
    { "type": "text", "id": "view_all_text", "label": "按钮文案", "default": "一覧を見る" }
  ],
  "presets": [
    { "name": "JP Collection Preview" }
  ]
}
{% endschema %}